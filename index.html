<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·åœ£æ¯ - æ½®æ±•è€çˆ·ä¿å·</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 4px solid #4a4a4a;
            width: 320px;
            height: 480px;
            background: #2C1E18;
            user-select: none;
            -webkit-user-select: none;
        }

        canvas {
            display: block;
            image-rendering: pixelated;
            width: 100%;
            height: 100%;
        }

        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 20;
            text-shadow: 2px 2px 0 #000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pixel-text {
            color: white;
            font-size: 20px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .sub-text {
            color: #FFD700;
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.9;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            font-family: 'Ma Shan Zheng', cursive;
        }

        /* Wish Input Styling */
        #wish-input {
            margin-top: 10px;
            width: 220px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #8B4513;
            border-radius: 8px;
            padding: 8px;
            color: #FFD700;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 16px;
            text-align: center;
            outline: none;
            pointer-events: auto; /* Enable typing */
            transition: all 0.3s ease;
        }

        #wish-input::placeholder {
            color: rgba(255, 215, 0, 0.5);
        }

        #wish-input:focus {
            background: rgba(0, 0, 0, 0.7);
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .controls-hint {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: #aaa;
            font-size: 10px;
            pointer-events: none;
            z-index: 20;
            padding: 0 10px;
        }

        #mobile-controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            height: 100px;
            display: none;
            pointer-events: auto;
            z-index: 30;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid white;
            color: white;
            font-family: inherit;
            font-weight: bold;
            border-radius: 8px;
            padding: 10px;
            user-select: none;
            backdrop-filter: blur(2px);
        }

        .btn:active {
            background: rgba(255, 255, 255, 0.4);
        }

        #btn-space {
            width: 100px;
            height: 60px;
            position: absolute;
            bottom: 0px;
            left: 50%;
            transform: translateX(-50%);
        }

        #btn-left {
            position: absolute;
            left: 20px;
            bottom: 10px;
            width: 60px;
            height: 60px;
        }

        #btn-right {
            position: absolute;
            right: 20px;
            bottom: 10px;
            width: 60px;
            height: 60px;
        }

        #settings-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            z-index: 40;
            background: rgba(0,0,0,0.3);
            border: 1px solid #666;
            border-radius: 4px;
            color: #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            pointer-events: auto;
        }

        /* AI Feature UI */
        #ai-interaction-layer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
        }

        .ai-btn {
            background: linear-gradient(135deg, #FFD700, #DAA520);
            border: 3px solid #8B4513;
            color: #5d2800;
            padding: 12px 24px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #8B4513, 0 10px 20px rgba(0,0,0,0.5);
            transition: transform 0.1s, box-shadow 0.1s;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
            user-select: none;
        }

        .ai-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #8B4513, 0 5px 10px rgba(0,0,0,0.5);
        }

        .ai-btn span {
            display: inline-block;
            animation: sparkle 2s infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Modals */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }

        .fortune-paper {
            background-color: #FFF0F5;
            background-image: 
                linear-gradient(90deg, transparent 95%, #ffdde1 95%),
                linear-gradient(transparent 95%, #ffdde1 95%);
            background-size: 20px 20px;
            width: 100%;
            max-width: 280px;
            padding: 0;
            border: 8px double #D93829;
            box-shadow: 0 0 30px rgba(217, 56, 41, 0.3);
            text-align: center;
            font-family: 'Ma Shan Zheng', cursive;
            position: relative;
            max-height: 80%;
            display: flex;
            flex-direction: column;
        }

        /* Scrollable Content Area */
        .fortune-scroll-area {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-paper {
            background-color: #333;
            width: 100%;
            max-width: 280px;
            padding: 20px;
            border: 2px solid #666;
            color: white;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .fortune-title {
            color: #D93829;
            font-size: 24px;
            margin-bottom: 15px;
            border-bottom: 2px solid #D93829;
            padding-bottom: 5px;
        }

        .fortune-content {
            color: #333;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        .fortune-ai-comment {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #D93829;
            font-size: 16px;
            color: #555;
            font-style: italic;
        }

        /* Fixed Button Group at Bottom */
        .modal-btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px 20px;
            background: rgba(255, 240, 245, 0.9);
            border-top: 1px solid rgba(217, 56, 41, 0.3);
        }

        .close-btn, .restart-btn {
            color: white;
            border: none;
            padding: 12px 15px;
            cursor: pointer;
            font-family: 'Ma Shan Zheng', cursive;
            border-radius: 50px;
            font-size: 16px;
            flex: 1;
            transition: transform 0.1s;
        }
        
        .close-btn:active, .restart-btn:active {
            transform: scale(0.95);
        }

        .close-btn {
            background: #555;
            border: 2px solid #333;
        }

        .restart-btn {
            background: #D93829; /* Red for emphasis */
            border: 2px solid #8B4513;
        }

        .input-key {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            background: #111;
            border: 1px solid #555;
            color: white;
            font-family: monospace;
            box-sizing: border-box;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FFD700;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        .key-status {
            font-size: 10px;
            margin-bottom: 5px;
            text-align: left;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div id="game-container">
        <div class="scanlines"></div>
        <button id="settings-btn" title="API è®¾ç½®">âš™ï¸</button>
        <div id="ui-layer">
            <div id="status-text" class="pixel-text">æŒ‰ä½ç©ºæ ¼è“„åŠ›</div>
            <div id="sub-text" class="sub-text" style="display:none;">ç©ºä¸­è°ƒæ•´ï¼Œå‡‘æˆ [å¹³] + [å‡¸] ä¸ºèƒœ</div>
            <!-- Wish Input Field -->
            <input type="text" id="wish-input" placeholder="åœ¨æ­¤é»˜å¿µå¿ƒä¸­æ‰€æ±‚..." maxlength="20">
        </div>
        
        <!-- AI Interaction Layer -->
        <div id="ai-interaction-layer">
            <button id="btn-ask-ai" class="ai-btn">âœ¨ è€çˆ·èµç¤º âœ¨</button>
        </div>

        <canvas id="gameCanvas" width="320" height="480"></canvas>
        
        <div class="controls-hint">
            ç”µè„‘: [ç©ºæ ¼] è“„åŠ›/é‡æ¥ | [â†/â†’] ç¿»è½¬<br>
            æ‰‹æœº: ä½¿ç”¨å±å¹•ä¸‹æ–¹æŒ‰é’®
        </div>
        
        <div id="mobile-controls">
            <button id="btn-left" class="btn">â†</button>
            <button id="btn-space" class="btn">æ·</button>
            <button id="btn-right" class="btn">â†’</button>
        </div>

        <!-- Fortune Modal -->
        <div id="fortune-modal" class="modal-overlay">
            <div id="loading-view" style="display:none; flex-direction:column; align-items:center; color:white;">
                <div class="loading-spinner"></div>
                <div style="font-family: 'Ma Shan Zheng'; font-size: 20px;" id="loading-text">è€çˆ·æ­£åœ¨æ–Ÿé…Œ...</div>
            </div>
            
            <div id="result-view" class="fortune-paper" style="display:none;">
                <div class="fortune-scroll-area">
                    <div class="fortune-title" id="fortune-title">ä¸Šä¸Šç­¾</div>
                    <div class="fortune-content" id="fortune-text"></div>
                    <div class="fortune-ai-comment" id="fortune-ai-comment" style="display:none;"></div>
                </div>
                
                <div class="modal-btn-group">
                    <button id="btn-accept" class="close-btn" onclick="closeFortuneModal()">æ”¶ä¸‹ç­¾æ–‡</button>
                    <button class="restart-btn" onclick="restartWithNewWish()">å†æ±‚ä¸€äº‹</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal-overlay">
            <div class="settings-paper">
                <h3>è®¾ç½® / Settings</h3>
                <div id="key-status-display" class="key-status"></div>
                <p style="font-size:12px; color:#aaa; margin-bottom: 5px;">è¯·è¾“å…¥æ‚¨çš„ DeepSeek / Gemini API Key:</p>
                <input type="password" id="api-key-input" class="input-key" placeholder="sk-...">
                <button class="close-btn" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
                <button class="close-btn" onclick="clearSettings()" style="background:#555; margin-top:5px;">æ¢å¤é»˜è®¤</button>
                <button class="close-btn" onclick="closeSettingsModal()" style="background:transparent; border:1px solid #555; margin-top:15px;">å…³é—­</button>
                <br><br>
                <div style="font-size:10px; color:#aaa;">
                    æ¨èä½¿ç”¨ <a href="https://platform.deepseek.com/" target="_blank" style="color:#FFD700;">DeepSeek</a> (å›½å†…å¯ç”¨) <br>
                    æˆ– Google Gemini (éœ€é­”æ³•)
                </div>
            </div>
        </div>
    </div>

<script>
/**
 * æ·åœ£æ¯ï¼šè€çˆ·ä¿å· - Ultimate Release (Dynamic Personas + Deep Reasoning)
 */

// ==========================================================
// ã€é…ç½®åŒºåŸŸã€‘è¯·åœ¨ä¸‹æ–¹å¡«å…¥æ‚¨çš„ API Key (å·²Base64ç¼–ç ä¿æŠ¤)
// é»˜è®¤é…ç½®ä¸º DeepSeek (sk-90bf60a9f9424f79bf3350983e008fcf)
const DEFAULT_CONFIG = {
    apiUrl: "https://api.deepseek.com/chat/completions",
    model: "deepseek-chat",
    // Base64 Encoded Key to prevent casual scraping
    key_enc: "c2stOTBiZjYwYTlmOTQyNGY3OWJmMzM1MDk4M2UwMDhmY2Y="
};
// ==========================================================

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const statusText = document.getElementById('status-text');
const subText = document.getElementById('sub-text');
const wishInput = document.getElementById('wish-input'); 
const aiLayer = document.getElementById('ai-interaction-layer');
const aiButton = document.getElementById('btn-ask-ai');
const fortuneModal = document.getElementById('fortune-modal');
const settingsModal = document.getElementById('settings-modal');
const loadingView = document.getElementById('loading-view');
const loadingText = document.getElementById('loading-text');
const resultView = document.getElementById('result-view');
const fortuneTitle = document.getElementById('fortune-title');
const fortuneText = document.getElementById('fortune-text');
const fortuneAiComment = document.getElementById('fortune-ai-comment');
const settingsBtn = document.getElementById('settings-btn');
const apiKeyInput = document.getElementById('api-key-input');
const keyStatusDisplay = document.getElementById('key-status-display');
const btnAccept = document.getElementById('btn-accept');

// --- Dynamic Personas ---
const PERSONAS = [
    {
        id: "kind", // æ…ˆæ‚²ç›¸
        weight: 0.6,
        system: `ä½ å³æ˜¯æ½®æ±•åœ°åŒºçš„å®ˆæŠ¤ç¥â€œè€çˆ·â€ã€‚
äººè®¾ï¼šæ…ˆç¥¥æ¸©æš–ï¼Œåƒå®¶é‡Œçš„è€ç¥–çˆ¶ï¼Œéå¸¸æŠ¤çŸ­ï¼Œå¿ƒç–¼ä¿¡å¾’ã€‚
è¯­è¨€é£æ ¼ï¼šåŠæ–‡åŠç™½ï¼Œå¤¹æ‚æ½®æ±•æ–¹è¨€ç‰¹è‰²ã€‚
å£å¤´ç¦…ï¼šç§°ç”¨æˆ·ä¸ºâ€œå¼Ÿå­â€ï¼Œå¸¸ç”¨â€œå‹¿æ…Œâ€ã€â€œé£ŸèŒ¶â€ã€â€œé¡ºé¡ºâ€ã€â€œè€çˆ·ä¿å·â€ã€‚
ä»»åŠ¡ï¼šæ·±åº¦ç»“åˆç­¾æ–‡å…¸æ•…ä¸ç”¨æˆ·å¿ƒæ„¿ï¼Œç»™å‡ºæ¸©æš–çš„æŒ‡å¼•å’Œå®‰æ…°ã€‚`
    },
    {
        id: "strict", // å¨ä¸¥ç›¸
        weight: 0.2,
        system: `ä½ å³æ˜¯æ½®æ±•åœ°åŒºçš„å®ˆæŠ¤ç¥â€œè€çˆ·â€ã€‚
äººè®¾ï¼šå¨ä¸¥æ­£ç›´ï¼Œé“é¢æ— ç§ï¼Œæ´å¯Ÿäººå¿ƒï¼Œä¸æ€’è‡ªå¨ã€‚
è¯­è¨€é£æ ¼ï¼šç®€ç»ƒæœ‰åŠ›ï¼Œå¤é£æµ“é‡ï¼Œä¸è‹Ÿè¨€ç¬‘ã€‚
å£å¤´ç¦…ï¼šç§°ç”¨æˆ·ä¸ºâ€œä¿¡å¥³/å–„ç”·â€ï¼Œå¸¸ç”¨â€œæ…ä¹‹â€ã€â€œå¤©é“é…¬å‹¤â€ã€â€œåˆ‡è®°â€ã€‚
ä»»åŠ¡ï¼šä¸€é’ˆè§è¡€åœ°æŒ‡å‡ºç­¾æ–‡ä¸­çš„è­¦ç¤ºï¼Œå‘Šè¯«ç”¨æˆ·è¦ä¿®èº«å…»å¾·ï¼Œä¸å¯å¦„æ±‚ã€‚`
    },
    {
        id: "witty", // é€šé€ç›¸
        weight: 0.2,
        system: `ä½ å³æ˜¯æ½®æ±•åœ°åŒºçš„å®ˆæŠ¤ç¥â€œè€çˆ·â€ã€‚
äººè®¾ï¼šçœ‹é€ä¸–ä¿—çš„è€é¡½ç«¥ï¼Œé£è¶£å¹½é»˜ï¼Œç”šè‡³æ˜¯æœ‰ç‚¹â€œçš®â€ã€‚
è¯­è¨€é£æ ¼ï¼šè½»æ¾è‡ªåœ¨ï¼Œå¸¦æœ‰ç¦…æ„ï¼Œå¶å°”ä¼šåé—®æˆ–åæ§½ã€‚
å£å¤´ç¦…ï¼šå¸¸ç”¨â€œæœ‰è¶£â€ã€â€œæœ‰å½±æ— ï¼Ÿâ€(çœŸçš„å—)ã€â€œä¸”å»â€ã€â€œè«å¼ºæ±‚â€ã€‚
ä»»åŠ¡ï¼šç”¨å¹½é»˜æˆ–æ‰“æœºé”‹çš„æ–¹å¼åŒ–è§£ç”¨æˆ·çš„æ‰§å¿µï¼Œå‘Šè¯‰ä»–ä»¬äººç”Ÿé™¤ç”Ÿæ­»æ— å¤§äº‹ã€‚`
    }
];

function getRandomPersona() {
    const rand = Math.random();
    let cumulative = 0;
    for (const p of PERSONAS) {
        cumulative += p.weight;
        if (rand < cumulative) return p;
    }
    return PERSONAS[0];
}

// --- Key Management Logic ---
let customApiKey = localStorage.getItem('shengbei_api_key') || "";
updateKeyStatus(!!customApiKey);

function updateKeyStatus(hasCustom) {
    if (hasCustom) {
        keyStatusDisplay.innerHTML = "ğŸ”§ å½“å‰ä½¿ç”¨: è‡ªå®šä¹‰ Key";
        keyStatusDisplay.style.color = "#FFD700";
    } else {
        if (DEFAULT_CONFIG.key_enc && DEFAULT_CONFIG.key_enc.length > 5) {
            keyStatusDisplay.innerHTML = "âœ… å½“å‰ä½¿ç”¨: é»˜è®¤ Key (å·²é…ç½®)";
            keyStatusDisplay.style.color = "#4CAF50";
        } else {
            keyStatusDisplay.innerHTML = "âš ï¸ æœªé…ç½® Key (AIåŠŸèƒ½ä¸å¯ç”¨)";
            keyStatusDisplay.style.color = "#FF4444";
        }
    }
}

function getEffectiveKey() {
    if (customApiKey && customApiKey.trim().length > 0) return customApiKey;
    try { return atob(DEFAULT_CONFIG.key_enc); } catch (e) { return ""; }
}

function showSettings() {
    apiKeyInput.value = customApiKey; 
    settingsModal.style.display = 'flex';
}

function closeSettingsModal() {
    settingsModal.style.display = 'none';
}

function saveSettings() {
    const input = apiKeyInput.value.trim();
    if (input.length > 0) {
        customApiKey = input;
        localStorage.setItem('shengbei_api_key', customApiKey);
        updateKeyStatus(true);
        alert("è‡ªå®šä¹‰ Key å·²ä¿å­˜ï¼ä¼˜å…ˆä½¿ç”¨æ‚¨çš„ Keyã€‚");
    } else {
        clearSettings();
    }
    settingsModal.style.display = 'none';
}

function clearSettings() {
    customApiKey = "";
    apiKeyInput.value = "";
    localStorage.removeItem('shengbei_api_key');
    updateKeyStatus(false);
}

settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); showSettings(); });
wishInput.addEventListener('keydown', (e) => { e.stopPropagation(); });

// Handle High DPI
const GAME_WIDTH = 320;
const GAME_HEIGHT = 480;
canvas.width = GAME_WIDTH * 2;
canvas.height = GAME_HEIGHT * 2;

const STATE = { START: 0, CHARGING: 1, THROWN: 2, BOUNCING: 3, RESULT: 4 };
const COLORS = {
    bg: '#2C1E18', gold: '#FFD700', red: '#D93829', wood: '#E5C087',
    skin: '#E8B796', altar: '#8B4513', shadow: 'rgba(0,0,0,0.5)',
    auraGold: 'rgba(255, 215, 0, 0.4)', auraRed: 'rgba(217, 56, 41, 0.4)'
};

let gameState = STATE.START;
let animTime = 0; 
let chargePower = 0;
let chargeDir = 1;
let resultType = ""; 
let blessingActive = false; 

const GRAVITY = 0.15; 
const FLOOR_Y = 380; 

const cups = {
    left: { x: 0, y: 0, vx: 0, vy: 0, rot: 0, rotSpeed: 0, isFlat: false },
    right: { x: 0, y: 0, vx: 0, vy: 0, rot: 0, rotSpeed: 0, isFlat: false }
};

const keys = { space: false, left: false, right: false };
let particles = [];
let currentFortune = null; 

// --- EXPANDED FORTUNES DATABASE (No bad luck) ---
const FORTUNES = [
    { title: "ç¬¬ä¸€ç­¾ ä¸Šä¸Š", poem: "å½©å‡¤å‘ˆç¥¥ç‘æ°”å¤šï¼Œ\nèº«è£å¯Œè´µä¹å¦‚ä½•ã€‚\nè…°é‡‘è¡£ç´«äººé’¦æ•¬ï¼Œ\nä¸€ä¸–è£åä¸è¹‰è·ã€‚" },
    { title: "ç¬¬äºŒç­¾ å¤§å‰", poem: "é²²é¹ä¸‡é‡Œä»»é£æ‰¬ï¼Œ\nå¥½æ™¯è‰¯è¾°åœ¨å¼‚ä¹¡ã€‚\nä¸ä½†åŠŸåèƒ½æ˜¾è¾¾ï¼Œ\nè£åå¯Œè´µå¯¿è€Œåº·ã€‚" },
    { title: "ç¬¬ä¸‰ç­¾ ä¸Šä¸Š", poem: "æ¯æœ¨é€¢æ˜¥è‰²æ›´é²œï¼Œ\nä¸»å…¬æ¬¢å–œåœ°ç”Ÿè¿ã€‚\nå¦‚ä»Šå–œå¾—å¤©èµç¦ï¼Œ\nç¥¸å»ç¾æ¶ˆç¦ç¦„å…¨ã€‚" },
    { title: "ç¬¬å››ç­¾ å¤§å‰", poem: "ä¸ƒå±‚å®å¡”å‘¨å‘¨å›´ï¼Œ\nå‡ å¤šç¥ä»™ä¸‹ç•Œæ¥ã€‚\nä»Šæ—¥é¾™æ¥¼æŠŠå®´ä¼šï¼Œ\næƒ³å›è´¢å¸›è‡ªå¤©æ¥ã€‚" },
    { title: "ç¬¬äº”ç­¾ ä¸Šå‰", poem: "æ—¥å‡ºä¸œæ–¹æ»¡å¤©çº¢ï¼Œ\næ„äº‘æ¶ˆæ•£è§é’ç©ºã€‚\næ­¤æ—¶ç™¾äº‹çš†å¦‚æ„ï¼Œ\nååˆ©åŒæ”¶æ˜¾å¨é£ã€‚" },
    { title: "ç¬¬å…­ç­¾ å¤§å‰", poem: "ç™»å±±æ¶‰æ°´æ­£å¤©å°ï¼Œ\nå°‘å°å§»ç¼˜é€æ¸æ¥ã€‚\næ­¤å»è¡Œäººå¾—åˆ©ä¾¿ï¼Œ\nè´µäººæ¥å¼•ç¬‘é¢œå¼€ã€‚" },
    { title: "ç¬¬ä¸ƒç­¾ ä¸Šå‰", poem: "æ¢…èŠ±å†»é›ªç»½èŠ³è²ï¼Œ\nä¸€å¤œæ˜¥é£é€æš–å½’ã€‚\nå›å­æ±‚è°‹çš†é‚æ„ï¼Œ\nè´µäººç›¸åŠ©æ˜¾å…‰è¾‰ã€‚" },
    { title: "ç¬¬å…«ç­¾ ä¸Šä¸Š", poem: "å¹³ç”Ÿä½œå–„æ„Ÿè‹å¤©ï¼Œ\nç¦å¯¿ç»µé•¿èƒœæ˜”è´¤ã€‚\nä»Šæ—¥å¾—é€¢çœŸé€ åŒ–ï¼Œ\nè£åå¯Œè´µä¸‡ä¸‡å¹´ã€‚" },
    { title: "ç¬¬ä¹ç­¾ ä¸­å‰", poem: "èˆŸè¡Œæ»©ä¸Šå¿½é‡é£ï¼Œ\nè´¹å°½å·¥å¤«æš‚æœªé€šã€‚\nåªæœ‰è´µäººè½»åŠ©åŠ›ï¼Œ\nä¾ç„¶ä¾æ—§æŒ‚å¸†è“¬ã€‚" },
    { title: "ç¬¬åç­¾ ä¸Šå‰", poem: "åå¹´çª—ä¸‹è‹¦åŠŸæ·±ï¼Œ\nä¸€æ—¦æˆåå››æµ·é’¦ã€‚\næ˜¾ç¥–è£å®—äººæ•¬é‡ï¼Œ\nä¸é¡»æ›´å»é—®çŸ¥éŸ³ã€‚" },
    { title: "ç¬¬åä¸€ç­¾ ä¸­å‰", poem: "ç»è¥ä½œäº‹è¦å¿ƒåšï¼Œ\nè´¹åŠ›åŠ³å¿ƒææœªå…¨ã€‚\nè‹¥å¾—è´µäººè½»æŒ‡å¼•ï¼Œ\nä¾ç„¶å¹³åœ°ä¹Ÿå°±æ˜¯å¤©ã€‚" },
    { title: "ç¬¬åäºŒç­¾ ä¸Šå‰", poem: "é’äº‘æœ‰è·¯å¿—ç™»å¤©ï¼Œ\né‡‘æ¦œé¢˜ååœ¨ç›®å‰ã€‚\nç¨³æ­¥èŸ¾å®«æŠ˜æ¡‚å»ï¼Œ\nå…‰å®—è€€ç¥–å¥½æµä¼ ã€‚" },
    { title: "ç¬¬åä¸‰ç­¾ ä¸­å¹³", poem: "è¡Œèˆ¹æŠŠèˆµè¦åœ¨ä¸­ï¼Œ\nä¸é¡»ä½¿åŠ›ä¸ä½¿åŠŸã€‚\næ½®æ°´æ¥æ—¶é£åˆé¡ºï¼Œ\nè‡ªç„¶è½½å¾—å®å½’ç¯·ã€‚" },
    { title: "ç¬¬åå››ç­¾ ä¸­å¹³", poem: "ä¸€ç‚¹ä¸¹å¿ƒä»¥æ­¤ä¸ºï¼Œ\né•¿æ±Ÿé£æµªä¸é¡»æ¨ã€‚\nç›®å‰åªç®¡å‹¤è€•ä½œï¼Œ\næ—¥åè£åè‡ªç„¶å›ã€‚" },
    { title: "ç¬¬åäº”ç­¾ ä¸­å¹³", poem: "å¹³åœ°è¡ŒèˆŸæ°´æµªå¤šï¼Œ\nå¿…é¡»ä»”ç»†æŠŠèˆ¹æ‹–ã€‚\nè‹¥èƒ½æŠŠèˆµå¿ƒå®‰ç¨³ï¼Œ\nä¸æ€•é£æ³¢å¥ˆæˆ‘ä½•ã€‚" },
    { title: "ç¬¬åå…­ç­¾ ä¸Šå‰", poem: "ç¦å¦‚ä¸œæµ·å¯¿å¦‚å±±ï¼Œ\nå›å°”ä½•é¡»å¹è‹¦éš¾ã€‚\nå‘½å†…è‡ªç„¶é€¢å¤§å‰ï¼Œ\nç¥ˆæ±‚ç¥åœ£ä¿å¹³å®‰ã€‚" },
    { title: "ç¬¬åä¸ƒç­¾ å¤§å‰", poem: "æ˜¥æ¥èŠ±å‘æ˜ é˜³å°ï¼Œ\nä¸‡é‡Œè½¦ä¹¦å°½å¸¦æ¥ã€‚\nå¥½æ™¯è‰¯è¾°å›å¯è§ï¼Œ\né—¨åº­å–œæ°”è‡ªå¤©æ¥ã€‚" },
    { title: "ç¬¬åå…«ç­¾ ä¸Šä¸Š", poem: "é‡‘ä¹Œè¥¿å å…”ä¸œå‡ï¼Œ\næ—¥å¤œå¾ªç¯æš‚ä¸åœã€‚\nåƒ§é“å¾—ä¹‹æ— ä¸åˆ©ï¼Œ\nå·¥å•†å†œå£«å„ç§°å¿ƒã€‚" },
    { title: "ç¬¬åä¹ç­¾ å¤§å‰", poem: "å®¶å®…æ¸…å‰å–œæ°”ç”Ÿï¼Œ\nç”°å›­ç¦¾ç¨»å²ä¸°ç™»ã€‚\nåˆå€¼æ˜¥é£å¤šå¯Œè´µï¼Œ\né—¨åº­ç‘æ°”ç™¾èˆ¬å…´ã€‚" },
    { title: "ç¬¬äºŒåç­¾ ä¸Šä¸Š", poem: "çµèŠç‘è‰ç”Ÿåº­å‰ï¼Œ\nä½™åº†æµä¼ äº¿ä¸‡å¹´ã€‚\nå¯Œè´µè£åå¤©æ³¨å®šï¼Œ\näº”ä¸–å…¶æ˜Œç¦ç»µç»µã€‚" },
    { title: "ç¬¬äºŒåä¸€ç­¾ å¤§å‰", poem: "æ±‚è°‹é‚æ„äº‹äº¨é€šï¼Œ\nä¸€ç†ç²¾é€šä¸‡ç†åŒã€‚\næ˜¥é£å¹èµ·è™½æœªè§‰ï¼Œ\nèŠ±å¼€å¶èŒ‚æ»¡å›­çº¢ã€‚" },
    { title: "ç¬¬äºŒåäºŒç­¾ ä¸Šä¸Š", poem: "ç–¾ç—…æ¶ˆé™¤èº«æ³°åº·ï¼Œ\nç”°å›­æˆç†Ÿå²æ”¶é•¿ã€‚\næ±‚è°‹å¾—åˆ©çš†å¦‚æ„ï¼Œ\nåˆå®¶è€å¹¼å°½å®‰åº·ã€‚" },
    { title: "ç¬¬äºŒåä¸‰ç­¾ ä¸Šå‰", poem: "ç¦ç¦„è£åå¤©æ³¨å®šï¼Œ\nä¸ç”¨è‹¦å¿ƒå»å¼ºæ±‚ã€‚\nè‡ªæœ‰è´µäººç›¸æ¥å¼•ï¼Œ\nä½•é¡»æ—¥å¤œä»¥æ­¤å¿§ã€‚" },
    { title: "ç¬¬äºŒåå››ç­¾ å¤§å‰", poem: "å¥½å°†å¿ƒäº‹å¿«ä¹è¡Œï¼Œ\nç¥æ˜æŠ¤ä½‘æŠ¥å¹³å®‰ã€‚\nè‹¥é—®å‰ç¨‹ä½•æ—¥å¾—ï¼Œ\nä¹Ÿé¡»ä¿®å¾·ä»¥æ­¤è§‚ã€‚" },
    { title: "ç¬¬äºŒåäº”ç­¾ ä¸Šä¸Š", poem: "å¤©å¼€åœ°è¾Ÿç»“è‰¯ç¼˜ï¼Œ\næ—¥å‰æ—¶è‰¯ä¸‡äº‹å…¨ã€‚\nè‹¥å¾—æ­¤ç­¾éå°å¯ï¼Œ\näººè¡Œä¸­æ­£å¸ç‹å®£ã€‚" },
    { title: "ç¬¬äºŒåå…­ç­¾ å¤§å‰", poem: "å·å·ç‹¬æ­¥å‘äº‘é—´ï¼Œ\nç‰æ®¿åƒå®˜ç¬¬ä¸€ç­ã€‚\nå¯Œè´µè£åå¤©ä»˜ä¸ï¼Œ\nç¦å¦‚ä¸œæµ·å¯¿å¦‚å±±ã€‚" },
    { title: "ç¬¬äºŒåä¸ƒç­¾ ä¸Šå‰", poem: "ä¸€é‡å±±åä¸€é‡æ°´ï¼Œ\næœªå¿…å±±é‡æ°´åˆæ·±ã€‚\nåªæŠŠå¯¸å¿ƒé€šå¤§é“ï¼Œ\nè‡ªç„¶åˆ°å¤„æœ‰çŸ¥éŸ³ã€‚" },
    { title: "ç¬¬äºŒåå…«ç­¾ å¤§å‰", poem: "å›å­æ­¤æ—¶æ¬²é—®åï¼Œ\nå¦‚é±¼å¾—æ°´åœ¨æ± åº­ã€‚\né£äº‘é™…ä¼šé¾™å¼€å£ï¼Œ\nä¾¿æœ‰é›·å£°éœ‡ä¹å†¥ã€‚" },
    { title: "ç¬¬äºŒåä¹ç­¾ ä¸Šä¸Š", poem: "ç¥–å®—ç§¯å¾—å¾·æµèŠ³ï¼Œ\nç¦æ³½ç»µç»µä¸–æ³½é•¿ã€‚\nä»Šæ—¥å­å­™å¤šå‘è¾¾ï¼Œ\nè£åå¯Œè´µå§“åé¦™ã€‚" },
    { title: "ç¬¬ä¸‰åç­¾ ä¸Šå‰", poem: "å–œé¹Šæªå‰æŠ¥å¥½éŸ³ï¼Œ\nçŸ¥å›åƒé‡Œæ¬²å½’å¿ƒã€‚\nä»Šæœå¾—é‡çœŸçŸ¥å·±ï¼Œ\nå¯¹æ­¤é£å…‰ä¹ä¸”åŸã€‚" }
];

const XIAOBEI_MSGS = [
    "å¿ƒä¸­æœ‰æ•°ï¼Œä½•å¿…é—®æˆ‘ï¼Ÿ", "ç¬‘è€Œä¸è¯­ï¼Œæœºç¼˜æœªåˆ°ã€‚", "å¼Ÿå­ï¼Œæ­¤äº‹ä¸å¿…å†é—®ã€‚", "è«å¼ºæ±‚ï¼Œé¡ºå…¶è‡ªç„¶ã€‚",
    "æ­¤å¦ä¸ºç¬‘ï¼Œæ„åœ¨è¨€å¤–ã€‚", "ä½ å…¶å®å·²ç»çŸ¥é“ç­”æ¡ˆäº†ã€‚", "é—®é¢˜å¤ªæ¨¡ç³Šï¼Œè€çˆ·å¬ä¸æ‡‚ã€‚", "ä¸”æ”¾å®½å¿ƒï¼Œä¸€ç¬‘ç½®ä¹‹ã€‚",
    "è€çˆ·æ­£åœ¨åƒèŒ¶ï¼Œç¨åå†é—®ã€‚", "é—®é¢˜å¤ªå¯çˆ±ï¼Œè€çˆ·ç¬‘äº†ã€‚", "å¿ƒè¯šåˆ™çµï¼Œå‹¿æ‰§ç€äºç­¾ã€‚", "æ­¤äº‹å¤©æœºï¼Œä¸å¯è¯´ç ´ã€‚"
];

const WENBEI_MSGS = [
    "æ—¶è¿æœªè‡³ï¼Œåˆ‡å‹¿å¦„åŠ¨ã€‚", "å¿ƒè¯šåˆ™çµï¼Œæ‚å¿µå¤ªé‡ã€‚", "æ­¤è·¯ä¸é€šï¼Œå¦å¯»ä»–æ³•ã€‚", "å¤©æœºä¸å¯æ³„éœ²ã€‚",
    "æš‚å®ˆæœ¬åˆ†ï¼Œå‹¿ç”Ÿè´ªå¿µã€‚", "è€çˆ·åœ¨å¿™ï¼Œæ”¹æ—¥å†æ¥ã€‚", "æ­¤äº‹ä¸å¯ä¸ºï¼Œæ…ä¹‹ã€‚", "é™å¿ƒä¿®å¾·ï¼Œç¦æŠ¥è‡ªæ¥ã€‚",
    "æ¬²é€Ÿåˆ™ä¸è¾¾ï¼Œä¸”æ…¢è¡Œã€‚", "é™è§‚å…¶å˜ï¼Œä¸å®œèºè¿›ã€‚", "å¿ƒä¸­æœ‰ç¢ï¼Œå…ˆå»å¿ƒé­”ã€‚", "è«ä¿¡ç›´ä¸­ç›´ï¼Œé¡»é˜²ä»ä¸ä»ã€‚"
];

// --- 1. Intent Analysis ---
async function checkWishIntent() {
    const wish = wishInput.value.trim();
    if (!wish) return; 
    const key = getEffectiveKey();
    if (!key) return; 

    try {
        const response = await fetch(DEFAULT_CONFIG.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
            body: JSON.stringify({ 
                model: DEFAULT_CONFIG.model,
                messages: [
                    { role: "system", content: "You are an intent classifier. If the user's wish implies praying for HEALTH, SAFETY, or RECOVERY for FAMILY members or FRIENDS, return 'YES'. Otherwise return 'NO'." },
                    { role: "user", content: `Wish: ${wish}` }
                ],
                stream: false
            })
        });
        
        const data = await response.json();
        const result = data.choices[0].message.content.trim().toUpperCase();
        
        if (result.includes("YES")) {
            console.log("è€çˆ·æ…ˆæ‚²ï¼Œè§¦å‘ç¥ä½‘ï¼");
            blessingActive = true;
        }
    } catch (e) {
        console.log("Intent check failed:", e);
    }
}

// --- 2. Result Interpretation (AI with Personas) ---
async function callAI(type) {
    const effectiveKey = getEffectiveKey();
    if (!effectiveKey) { showSettings(); return; }

    fortuneModal.style.display = 'flex';
    loadingView.style.display = 'flex';
    resultView.style.display = 'none';
    
    const loadingTexts = ["è€çˆ·æ­£åœ¨æŸ¥é˜…å¤©ä¹¦...", "é¦™çƒŸè¢…è¢…ï¼Œæ²Ÿé€šå¤©åº­...", "æ­£åœ¨è†å¬å¼Ÿå­å¿ƒå£°...", "åœ£æ¯è½åœ°ï¼Œç¥æœºæ˜¾ç°..."];
    loadingText.innerText = loadingTexts[Math.floor(Math.random() * loadingTexts.length)];

    const userWish = wishInput.value.trim();
    let wishContext = userWish 
        ? `ä¿¡å¾’å¿ƒä¸­æ‰€æ±‚ä¹‹äº‹ä¸ºï¼šâ€œ${userWish}â€ã€‚è¯·åŠ¡å¿…ç»“åˆæ­¤äº‹è¿›è¡Œå…·ä½“è§£è¯»ï¼Œä¸è¦æ³›æ³›è€Œè°ˆã€‚` 
        : "ä¿¡å¾’å¿ƒä¸­æ— å…·ä½“æ‰€æŒ‡ï¼Œæ±‚æ•´ä½“è¿åŠ¿ã€‚";

    // Select Persona
    let selectedPersona = getRandomPersona();
    if (type === "XIAOBEI" && Math.random() > 0.5) selectedPersona = PERSONAS.find(p => p.id === "witty");
    if (blessingActive) selectedPersona = PERSONAS.find(p => p.id === "kind");

    let systemPrompt = selectedPersona.system + "\n\nçº¦æŸï¼š\n1. å›å¤é™åˆ¶åœ¨ 80 å­—ä»¥å†…ã€‚\n2. ä¸¥ç¦å‡ºç°â€˜ä½œä¸ºAIâ€™ç­‰å­—çœ¼ã€‚\n3. å¿…é¡»åŒ…å«æ½®æ±•/å¤é£ç‰¹è‰²è¯æ±‡ã€‚\n4. è‹¥æ˜¯ä¸Šç­¾ï¼Œå¤šç»™é¼“åŠ±ï¼›è‹¥æ˜¯ç¬‘æ¯/ç¨³æ¯ï¼Œå¤šç»™å“²ç†æŒ‡å¼•ã€‚";
    let userPrompt = "";
    
    if (type === "SHENGBEI") {
        if (blessingActive) {
            const bestFortunes = FORTUNES.filter(f => f.title.includes("ä¸Šä¸Š") || f.title.includes("å¤§å‰"));
            currentFortune = bestFortunes[Math.floor(Math.random() * bestFortunes.length)];
        } else {
            const randomIndex = Math.floor(Math.random() * FORTUNES.length);
            currentFortune = FORTUNES[randomIndex];
        }
        
        fortuneTitle.innerText = "âœ¨ " + currentFortune.title + " âœ¨";
        fortuneText.innerText = currentFortune.poem;
        btnAccept.innerText = "æ”¶ä¸‹ç­¾æ–‡";
        userPrompt = `ä¿¡å¾’æ·å‡ºäº†ã€èƒœæ¯ã€‘(åœ£æ„è®¸å¯)ã€‚æŠ½åˆ°çš„ç­¾æ–‡æ˜¯ï¼šâ€œ${currentFortune.title} - ${currentFortune.poem.replace(/\n/g, ', ')}â€ã€‚${wishContext} è¯·æŒ‰ç…§æ‚¨çš„äººè®¾è¿›è¡Œè§£è¯»ã€‚å…ˆè§£é‡Šç­¾æ–‡å¯“æ„ï¼Œå†é’ˆå¯¹å¿ƒæ„¿ç»™å‡ºæŒ‡å¼•ï¼Œæœ€åé€ä¸Šç¥ç¦ã€‚`;
    } else if (type === "XIAOBEI") {
        const msg = XIAOBEI_MSGS[Math.floor(Math.random() * XIAOBEI_MSGS.length)];
        fortuneTitle.innerText = "â˜ï¸ è€çˆ·ç¬‘äº† â˜ï¸";
        fortuneText.innerText = msg;
        btnAccept.innerText = "è°¨éµç¥ç¤º";
        userPrompt = `ä¿¡å¾’æ·å‡ºäº†ã€ç¬‘æ¯ã€‘(ç¥æ˜å‘ç¬‘/æœªç½®å¯å¦)ã€‚æ‚¨ç»™å‡ºçš„éšæœºç¥è°•æ˜¯ï¼šâ€œ${msg}â€ã€‚${wishContext} è¯·ç”¨æ‚¨çš„äººè®¾è§£é‡Šä¸ºä½•å‘ç¬‘ï¼Ÿæ˜¯ä¸æ˜¯ä¿¡å¾’çš„é—®é¢˜å¤ªå¤©çœŸï¼Œæˆ–è€…ç­”æ¡ˆæ˜¾è€Œæ˜“è§ï¼Ÿè¯·å¹½é»˜æˆ–æ¸©æš–åœ°åŒ–è§£ä¿¡å¾’çš„ç–‘æƒ‘ã€‚`;
    } else {
        const msg = WENBEI_MSGS[Math.floor(Math.random() * WENBEI_MSGS.length)];
        fortuneTitle.innerText = "â›°ï¸ è€çˆ·ä¸è¯­ â›°ï¸";
        fortuneText.innerText = msg;
        btnAccept.innerText = "è°¨éµç¥ç¤º";
        userPrompt = `ä¿¡å¾’æ·å‡ºäº†ã€ç¨³æ¯ã€‘(ç¥æ˜æ‹’ç»/æ—¶æœºæœªåˆ°)ã€‚æ‚¨ç»™å‡ºçš„éšæœºç¥è°•æ˜¯ï¼šâ€œ${msg}â€ã€‚${wishContext} è¯·ç”¨æ‚¨çš„äººè®¾ä¸¥è‚ƒåœ°å‘ŠçŸ¥ä¿¡å¾’ä¸ºä½•ä¸åº”æ­¤æ—¶å¼ºæ±‚ï¼Ÿæ˜¯ä¸æ˜¯å¿ƒä¸è¯šï¼Œæˆ–è€…æ—¶æœºæœªåˆ°ï¼Ÿè¯·ç»™å‡ºå¯Œæœ‰å“²ç†çš„åŠè¯«ã€‚`;
    }

    try {
        const response = await fetch(DEFAULT_CONFIG.apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${effectiveKey}` },
            body: JSON.stringify({ 
                model: DEFAULT_CONFIG.model,
                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }],
                stream: false, temperature: 0.8
            })
        });
        const data = await response.json();
        const text = data.choices[0].message.content;
        
        loadingView.style.display = 'none';
        resultView.style.display = 'flex';
        fortuneAiComment.innerText = "ã€è€çˆ·ç¥ç¤ºã€‘\n" + text;
        fortuneAiComment.style.display = 'block';
    } catch (error) {
        console.error(error);
        loadingView.style.display = 'none';
        resultView.style.display = 'flex';
        
        let fallbackMsg = "";
        if (type === "SHENGBEI") fallbackMsg = "ã€è€çˆ·ç¥ç¤ºã€‘\nå¿ƒè¯šåˆ™çµï¼Œæ‰€æ±‚ä¹‹äº‹å¿…æœ‰å›å“ã€‚æ­¤ç­¾å¤§å‰ï¼Œå®‰å¿ƒå‰è¡Œå³å¯ã€‚";
        else if (type === "XIAOBEI") fallbackMsg = "ã€è€çˆ·ç¥ç¤ºã€‘\nè«æ€¥è«æ€¥ï¼Œæ­¤äº‹çœ‹æ¥æ‚¨å¿ƒä¸­æ—©æœ‰å®šæ•°ï¼Œä½•å¿…å†é—®ï¼Ÿå¼€å¿ƒä¾¿å¥½ã€‚";
        else fallbackMsg = "ã€è€çˆ·ç¥ç¤ºã€‘\næ—¶æœºæœªåˆ°ï¼Œæš‚ä¸”ä¿®èº«å…»æ€§ï¼Œå¾…æ—¶è¿æµè½¬å†æ¥é—®è¯¢ã€‚";
        
        fortuneAiComment.innerText = fallbackMsg + "\n(ç½‘ç»œä¸ä½³ï¼Œæ˜¾ç¤ºç¦»çº¿è§£è¯»)";
        fortuneAiComment.style.display = 'block';
    }
}

function closeFortuneModal() {
    fortuneModal.style.display = 'none';
}

function restartWithNewWish() {
    closeFortuneModal();
    resetGame();
}

aiButton.addEventListener('click', (e) => {
    e.stopPropagation();
    callAI(resultType);
});

// --- Drawing ---
function drawRect(x, y, w, h, color) {
    ctx.fillStyle = color;
    ctx.fillRect(Math.floor(x), Math.floor(y), w, h);
}

const SHENGBEI_PIXELS = {
    flat: [[0,0,0,1,1,1,1,1,0,0,0,0], [0,0,1,1,1,2,2,2,1,0,0,0], [0,1,1,1,2,2,2,2,1,1,0,0],[1,1,1,1,2,2,2,2,1,1,1,0], [1,1,1,1,1,1,1,1,1,1,1,0], [1,1,1,1,0,0,0,0,1,1,1,0],[1,1,1,0,0,0,0,0,0,1,1,0], [1,1,0,0,0,0,0,0,0,1,1,0], [1,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0]],
    round: [[0,0,0,1,1,1,1,1,0,0,0,0], [0,0,1,1,1,1,1,1,1,0,0,0], [0,1,1,1,2,2,1,1,1,1,0,0],[1,1,1,2,2,2,2,1,1,1,1,0], [1,1,1,2,2,2,2,1,1,1,1,0], [1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,0,0,0,0,0,0,1,1,0], [1,1,0,0,0,0,0,0,0,1,1,0], [1,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0]],
    side: [[0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0], [0,1,1,1,1,1,1,1,1,1,0,0], [1,1,1,1,1,1,1,1,1,1,1,0],[1,1,0,0,0,0,0,0,0,1,1,0], [1,0,0,0,0,0,0,0,0,0,1,0], [0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0]]
};

function drawPixelSprite(x, y, grid, colorMap, scale = 2, rot = 0, auraColor = null) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(rot);
    const offset = (grid.length / 2) * scale;
    if (auraColor) {
        ctx.shadowColor = auraColor; ctx.shadowBlur = 20; ctx.fillStyle = auraColor;
        ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; 
    }
    for(let r=0; r<grid.length; r++) {
        for(let c=0; c<grid[0].length; c++) {
            const val = grid[r][c];
            if(val > 0) {
                ctx.fillStyle = colorMap[val];
                ctx.fillRect(c * scale - offset, r * scale - offset, scale, scale);
            }
        }
    }
    ctx.restore();
}

function drawLaoYe() {
    const cx = GAME_WIDTH / 2; const cy = 120;
    ctx.save(); ctx.scale(2, 2);
    ctx.globalAlpha = 0.2 + Math.sin(animTime * 0.05) * 0.1;
    ctx.beginPath(); ctx.arc(cx, cy, 60, 0, Math.PI * 2); ctx.fillStyle = COLORS.gold; ctx.fill(); ctx.globalAlpha = 1.0;
    drawRect(cx - 30, cy, 60, 80, '#A62619'); drawRect(cx - 10, cy, 20, 80, COLORS.gold);
    drawRect(cx - 40, cy + 5, 10, 30, '#801A10'); drawRect(cx + 30, cy + 5, 10, 30, '#801A10');
    drawRect(cx - 15, cy - 35, 30, 35, '#E8C0A0'); drawRect(cx - 15, cy - 35, 30, 10, 'black');
    drawRect(cx - 10, cy - 45, 20, 10, COLORS.gold); drawRect(cx - 10, cy - 5, 20, 25, 'white');
    drawRect(cx - 5, cy + 20, 10, 15, '#ddd'); drawRect(cx - 8, cy - 20, 4, 2, 'black');
    drawRect(cx + 4, cy - 20, 4, 2, 'black'); drawRect(0, 250, GAME_WIDTH, 100, COLORS.altar);
    drawRect(cx - 20, 240, 40, 20, '#CD7F32'); drawRect(cx - 15, 235, 30, 5, '#A0522D');
    drawRect(cx - 5, 215, 2, 20, '#D2691E'); drawRect(cx, 210, 2, 25, '#D2691E'); drawRect(cx + 5, 215, 2, 20, '#D2691E');
    if (Math.floor(animTime) % 4 === 0 && Math.random() < 0.2) {
         particles.push({x: (cx * 2) + (Math.random() - 0.5) * 10, y: 420, vx: (Math.random() - 0.5) * 0.5, vy: -0.5 - Math.random() * 0.5, life: 80, color: 'rgba(200,200,200,0.4)', size: 4});
    }
    ctx.restore();
}

function drawHands() {
    let yOffset = 0;
    if (gameState === STATE.CHARGING) yOffset = Math.sin(animTime * 0.8) * 2 + chargePower * 0.5;
    else if (gameState === STATE.THROWN) yOffset = 300; 
    else if (gameState === STATE.START) yOffset = Math.sin(animTime * 0.05) * 3;
    const lx = 80; const rx = 240; const by = 400 + yOffset;
    ctx.save(); ctx.scale(2, 2);
    drawRect(lx - 20, by, 40, 40, COLORS.skin); drawRect(lx - 15, by - 5, 10, 20, COLORS.skin); drawRect(lx - 5, by - 10, 10, 20, COLORS.skin); drawRect(lx + 5, by - 8, 10, 18, COLORS.skin);
    drawRect(rx - 20, by, 40, 40, COLORS.skin); drawRect(rx + 5, by - 5, 10, 20, COLORS.skin); drawRect(rx - 5, by - 10, 10, 20, COLORS.skin); drawRect(rx - 15, by - 8, 10, 18, COLORS.skin);
    if (gameState === STATE.START || gameState === STATE.CHARGING) {
        drawPixelSprite(lx + 5, by, SHENGBEI_PIXELS.side, {1: COLORS.red}, 3, -Math.PI/2);
        drawPixelSprite(rx - 5, by, SHENGBEI_PIXELS.side, {1: COLORS.red}, 3, Math.PI/2);
    }
    ctx.restore();
}

function drawPixelShengbei(cup) {
    let grid, colors;
    const scale = 3; 
    const rotation = cup.rot;
    let showFlat = false;
    if (cup.y >= FLOOR_Y && Math.abs(cup.vy) < 0.1) showFlat = cup.isFlat;
    else showFlat = Math.cos(rotation) > 0;

    if (Math.abs(Math.cos(rotation)) > 0.5) { 
        if (showFlat) { grid = SHENGBEI_PIXELS.flat; colors = {1: COLORS.wood, 2: '#F4D090'}; } 
        else { grid = SHENGBEI_PIXELS.round; colors = {1: COLORS.red, 2: '#FF5544'}; }
    } else {
        grid = SHENGBEI_PIXELS.side; colors = {1: COLORS.red};
    }
    drawPixelSprite(cup.x, cup.y, grid, colors, scale, rotation);

    if (gameState === STATE.THROWN) {
        ctx.save(); ctx.translate(cup.x, cup.y - 40); 
        const wouldBeFlat = Math.cos(rotation) > 0;
        let label = wouldBeFlat ? "å¹³" : "å‡¸";
        ctx.font = "bold 24px 'Ma Shan Zheng', sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillStyle = wouldBeFlat ? COLORS.gold : COLORS.red;
        ctx.strokeStyle = "black"; ctx.lineWidth = 4; ctx.strokeText(label, 0, -10); ctx.fillText(label, 0, -10);
        ctx.restore();
    }
}

function updateParticles() {
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--;
        ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
        if (p.life <= 0) particles.splice(i, 1);
    }
}

function createExplosion(x, y, color) {
    for(let i=0; i<15; i++) {
        particles.push({x: x * 2, y: y * 2, vx: (Math.random() - 0.5) * 6, vy: (Math.random() - 0.5) * 6, life: 30, color: color, size: 6});
    }
}

// --- Game Logic ---
function resetGame() {
    gameState = STATE.START; chargePower = 0;
    statusText.innerText = "æŒ‰ä½ç©ºæ ¼è“„åŠ›"; subText.style.display = "none"; 
    statusText.style.color = "white"; wishInput.style.display = "block"; wishInput.value = "";
    aiLayer.style.display = 'none'; resultType = ""; currentFortune = null; blessingActive = false; // Reset blessing
    cups.left = { x: 80, y: FLOOR_Y, vx: 0, vy: 0, rot: 0, rotSpeed: 0, isFlat: false };
    cups.right = { x: 240, y: FLOOR_Y, vx: 0, vy: 0, rot: 0, rotSpeed: 0, isFlat: false };
}

function throwCups() {
    gameState = STATE.THROWN; subText.style.display = "block"; wishInput.style.display = "none"; 
    const power = 14 + (chargePower / 100) * 4; 
    cups.left.x = 80; cups.left.y = 400; cups.left.vy = -power; cups.left.vx = 0.5 + Math.random() * 1.5; cups.left.rotSpeed = 0.1 + Math.random() * 0.1;
    cups.right.x = 240; cups.right.y = 400; cups.right.vy = -power; cups.right.vx = -(0.5 + Math.random() * 1.5); cups.right.rotSpeed = -(0.1 + Math.random() * 0.1);
    statusText.innerText = "ç©ºä¸­æŒ‰ â† â†’ ç¿»è½¬!";
    // Check Wish Intent Asynchronously
    checkWishIntent();
}

function checkResult() {
    const leftFlat = cups.left.isFlat; const rightFlat = cups.right.isFlat;
    subText.style.display = "none";
    setTimeout(() => {
        gameState = STATE.RESULT; aiLayer.style.display = 'flex'; 
        if (leftFlat !== rightFlat) {
            resultType = "SHENGBEI"; statusText.innerText = "â˜… èƒœæ¯ï¼è€çˆ·ä¿å· â˜…"; statusText.style.color = "#FFD700";
            aiButton.innerText = "âœ¨ æ±‚æ”¯çµç­¾ âœ¨"; createExplosion(GAME_WIDTH/2, 150, COLORS.gold);
        } else if (!leftFlat && !rightFlat) {
            resultType = "WENBEI"; statusText.innerText = "ç¨³æ¯ (ä¸¤å‡¸/é˜´)"; statusText.style.color = "#D93829";
            aiButton.innerText = "â›°ï¸ è¯¢é—®è€çˆ· â›°ï¸";
        } else {
            resultType = "XIAOBEI"; statusText.innerText = "ç¬‘æ¯ (ä¸¤å¹³/é˜³)"; statusText.style.color = "#E5C087";
            aiButton.innerText = "â˜ï¸ è€çˆ·ä¸ºä½•å‘ç¬‘? â˜ï¸";
        }
    }, 500);
}

function updatePhysics(dt) {
    if (gameState === STATE.THROWN || gameState === STATE.BOUNCING) {
        let physicsDt = dt; let settledCount = 0;
        [cups.left, cups.right].forEach((cup, idx) => {
            if (cup.y < FLOOR_Y) cup.vy += GRAVITY * physicsDt;
            cup.x += cup.vx * physicsDt; cup.y += cup.vy * physicsDt; cup.rot += cup.rotSpeed * physicsDt;
            if (cup.x < 30 || cup.x > GAME_WIDTH - 30) cup.vx *= -0.5;
            if (cup.y >= FLOOR_Y) {
                cup.y = FLOOR_Y;
                if (Math.abs(cup.vy) > 1.5) { cup.vy *= -0.4; cup.vx *= Math.pow(0.8, physicsDt); } 
                else {
                    // Settle Logic with Divine Intervention
                    cup.vy = 0; cup.vx = 0; cup.rotSpeed = 0;
                    
                    // DIVINE BLESSING: Force specific outcome if active
                    if (blessingActive) {
                        // Left: Flat (0), Right: Round (PI) -> Shengbei
                        if (idx === 0) { cup.rot = 0; cup.isFlat = true; } 
                        else { cup.rot = Math.PI; cup.isFlat = false; }
                    } else {
                        // Normal Physics
                        const phase = Math.cos(cup.rot);
                        cup.isFlat = phase > 0; cup.rot = cup.isFlat ? 0 : Math.PI;
                    }
                }
            }
            if (cup.vy === 0 && cup.y === FLOOR_Y) settledCount++;
        });
        if (settledCount === 2 && gameState !== STATE.BOUNCING && gameState !== STATE.RESULT) {
            gameState = STATE.BOUNCING; checkResult();
        }
    }
}

function flipCup(side) {
    if (gameState !== STATE.THROWN) return;
    const cup = side === 'left' ? cups.left : cups.right;
    cup.rotSpeed += (side === 'left' ? 0.3 : -0.3); cup.rot += Math.PI / 2; cup.vy -= 2.5; 
    createExplosion(cup.x, cup.y, 'white');
}

function update(dt) {
    animTime += dt;
    if (gameState === STATE.START) {
        if (keys.space) { gameState = STATE.CHARGING; chargePower = 0; }
    } else if (gameState === STATE.CHARGING) {
        if (keys.space) { chargePower += chargeDir * 2 * dt; if (chargePower > 100 || chargePower < 0) chargeDir *= -1; } 
        else { throwCups(); }
    } else if (gameState === STATE.RESULT) {
        if (keys.space && fortuneModal.style.display === 'none' && settingsModal.style.display === 'none') { resetGame(); keys.space = false; }
    }
    updatePhysics(dt);
}

function draw() {
    ctx.fillStyle = COLORS.bg; ctx.fillRect(0, 0, canvas.width, canvas.height);
    drawLaoYe(); drawHands(); 
    if (gameState !== STATE.START && gameState !== STATE.CHARGING) {
        ctx.save(); ctx.scale(2, 2); ctx.fillStyle = COLORS.shadow;
        [cups.left, cups.right].forEach(c => {
            const shadowScale = 1 - (FLOOR_Y - c.y)/300; 
            if (shadowScale > 0) { ctx.beginPath(); ctx.ellipse(c.x, FLOOR_Y + 12, 12 * shadowScale, 6 * shadowScale, 0, 0, Math.PI*2); ctx.fill(); }
        });
        drawPixelShengbei(cups.left); drawPixelShengbei(cups.right);
        ctx.restore();
    }
    if (gameState === STATE.CHARGING) {
        ctx.save(); ctx.scale(2, 2); ctx.fillStyle = '#555'; ctx.fillRect(110, 350, 100, 10);
        ctx.fillStyle = '#ff0'; ctx.fillRect(110, 350, chargePower, 10);
        ctx.strokeStyle = '#fff'; ctx.strokeRect(110, 350, 100, 10); ctx.restore();
    }
    updateParticles(); 
}

window.addEventListener('keydown', e => { if (e.code === 'Space') keys.space = true; if (e.code === 'ArrowLeft') { keys.left = true; flipCup('left'); } if (e.code === 'ArrowRight') { keys.right = true; flipCup('right'); } });
window.addEventListener('keyup', e => { if (e.code === 'Space') keys.space = false; });
const handleTouch = (keyName, isDown) => {
    if (keyName === 'space') { keys.space = isDown; if(isDown && gameState === STATE.RESULT && fortuneModal.style.display === 'none' && settingsModal.style.display === 'none') { resetGame(); keys.space = false; } }
    if (keyName === 'left' && isDown) flipCup('left'); if (keyName === 'right' && isDown) flipCup('right');
};
if ('ontouchstart' in window) document.getElementById('mobile-controls').style.display = 'flex';
document.getElementById('btn-space').addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('space', true); });
document.getElementById('btn-space').addEventListener('touchend', (e) => { e.preventDefault(); handleTouch('space', false); });
document.getElementById('btn-left').addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('left', true); });
document.getElementById('btn-right').addEventListener('touchstart', (e) => { e.preventDefault(); handleTouch('right', true); });

// Initialize modals to hidden state immediately
// This fixes the issue where spacebar reset doesn't work locally because style.display is empty initially
fortuneModal.style.display = 'none';
settingsModal.style.display = 'none';

let lastTime = 0;
function loop(timestamp) {
    if (!lastTime) lastTime = timestamp;
    let deltaTime = timestamp - lastTime;
    if (deltaTime > 50) deltaTime = 50;
    lastTime = timestamp;
    const timeScale = deltaTime / 16.67;
    update(timeScale);
    draw();
    requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
